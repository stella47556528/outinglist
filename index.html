<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>行程小幫手 Planner</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#f59e0b">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="行程小幫手">
    
    <!-- Manifest (Embedded using Data URI for single file requirement) -->
    <link rel="manifest" href='data:application/manifest+json,{"name":"行程小幫手 Planner","short_name":"行程小幫手","description":"專為行動裝置優化的行程管理工具","start_url":".","display":"standalone","background_color":"#ffffff","theme_color":"#f59e0b","icons":[{"src":"https://cdn-icons-png.flaticon.com/512/854/854878.png","sizes":"512x512","type":"image/png"}]}'>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #fef3c7; /* 琥珀黃底色 (Amber 100) */
            overscroll-behavior: none;
        }

        .task-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .completed {
            background-color: #fef9c3 !important;
            border-color: #eab308 !important;
            opacity: 0.85;
        }

        .completed .task-text {
            text-decoration: line-through;
            color: #713f12;
        }

        .modal-enter {
            animation: modalFadeIn 0.2s ease-out;
        }

        @keyframes modalFadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
    </style>
</head>
<body class="max-w-md mx-auto min-h-screen shadow-2xl bg-white flex flex-col relative">

    <!-- Header -->
    <header class="bg-white border-b border-amber-100 sticky top-0 z-30 px-4 py-4 flex items-center justify-between">
        <h1 class="text-xl font-bold text-amber-600">行程小幫手</h1>
        
        <!-- 待辦項目提醒 (Center) -->
        <div onclick="setFilter('todo')" class="cursor-pointer bg-amber-50 px-3 py-1 rounded-full border border-amber-200 animate-pulse">
            <span class="text-xs font-bold text-amber-800">進行中: <span id="todo-count">0</span></span>
        </div>

        <!-- 新增按鈕 (Right) -->
        <button onclick="openAddModal()" class="w-10 h-10 bg-amber-500 text-white rounded-full flex items-center justify-center shadow-lg active:scale-95 transition-transform">
            <i class="fas fa-plus"></i>
        </button>
    </header>

    <!-- 分類過濾 (Tabs) -->
    <nav class="flex border-b border-amber-100 text-sm font-medium bg-amber-50/50">
        <button onclick="setFilter('todo')" id="tab-todo" class="flex-1 py-3 border-b-2 border-amber-500 text-amber-700">進行中</button>
        <button onclick="setFilter('all')" id="tab-all" class="flex-1 py-3 border-b-2 border-transparent text-slate-500">全部</button>
        <button onclick="setFilter('done')" id="tab-done" class="flex-1 py-3 border-b-2 border-transparent text-slate-500">已完成</button>
    </nav>

    <!-- 行程列表清單 -->
    <main id="task-list" class="flex-1 overflow-y-auto p-4 space-y-4 no-scrollbar pb-24">
        <!-- 動態生成的卡片將放在這裡 -->
    </main>

    <!-- 回收站懸浮按鈕 (Bottom Right) -->
    <button onclick="toggleTrash()" class="fixed bottom-6 right-6 w-14 h-14 bg-slate-900 text-white rounded-full shadow-2xl flex items-center justify-center z-40 active:scale-90 transition-transform">
        <i class="fas fa-trash"></i>
    </button>

    <!-- 回收站面板 -->
    <div id="trash-panel" class="fixed inset-0 bg-black/60 z-50 hidden flex items-end justify-center">
        <div class="bg-slate-900 w-full max-w-md rounded-t-3xl p-6 h-[70vh] flex flex-col text-white">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold flex items-center gap-2">
                    <i class="fas fa-recycle text-amber-400"></i> 回收站
                </h2>
                <button onclick="toggleTrash()" class="text-slate-400 hover:text-white">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div id="trash-list" class="flex-1 overflow-y-auto space-y-4 no-scrollbar">
                <!-- 回收站項目 -->
            </div>
        </div>
    </div>

    <!-- 新增/編輯彈窗 -->
    <div id="editor-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 modal-enter shadow-2xl border-t-8 border-amber-500">
            <h3 id="modal-title" class="text-lg font-bold mb-4 text-amber-800">你要去哪裡？</h3>
            <textarea id="task-input" class="w-full h-32 p-4 bg-amber-50 rounded-2xl border border-amber-100 focus:outline-none focus:ring-2 focus:ring-amber-500 mb-4" placeholder="輸入行程內容..."></textarea>
            <div class="flex gap-3">
                <button onclick="closeEditorWithCheck()" class="flex-1 py-3 rounded-xl bg-slate-100 text-slate-600 font-bold">取消</button>
                <button onclick="saveTask()" class="flex-1 py-3 rounded-xl bg-amber-500 text-white font-bold shadow-lg shadow-amber-200">儲存</button>
            </div>
        </div>
    </div>

    <!-- 未儲存警示彈窗 -->
    <div id="alert-modal" class="fixed inset-0 bg-black/50 z-[60] hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-xs rounded-2xl p-6 shadow-2xl text-center">
            <i class="fas fa-exclamation-triangle text-amber-600 text-4xl mb-4"></i>
            <h3 class="text-lg font-bold mb-2 text-slate-800">尚未儲存變更</h3>
            <p class="text-sm text-slate-500 mb-6">您剛才編輯的內容還沒儲存，確定要放棄嗎？</p>
            <div class="flex flex-col gap-2">
                <button onclick="saveTask()" class="w-full py-3 bg-amber-500 text-white rounded-xl font-bold">儲存並離開</button>
                <button onclick="forceCloseEditor()" class="w-full py-3 bg-slate-100 text-slate-400 rounded-xl font-bold">放棄變更</button>
            </div>
        </div>
    </div>

    <!-- PWA 安裝提示 (Optional UI) -->
    <div id="install-banner" class="fixed bottom-24 left-4 right-4 bg-amber-600 text-white p-4 rounded-2xl shadow-2xl z-50 hidden flex items-center justify-between">
        <div class="flex items-center gap-3">
            <i class="fas fa-mobile-alt text-2xl"></i>
            <div>
                <p class="text-sm font-bold">安裝「行程小幫手」</p>
                <p class="text-[10px] opacity-80">將它加入桌面，隨時紀錄不迷路</p>
            </div>
        </div>
        <button id="install-btn" class="bg-white text-amber-600 px-4 py-2 rounded-xl text-xs font-bold">安裝</button>
    </div>

    <script>
        // 狀態管理
        let tasks = [];
        let trash = [];
        let currentFilter = 'todo'; 
        let editingId = null;
        let originalContent = "";

        // 初始化
        function init() {
            render();
            registerPWA();
        }

        // PWA 註冊與安裝邏輯
        function registerPWA() {
            // 1. 註冊 Service Worker
            if ('serviceWorker' in navigator) {
                // 使用 Blob 建立 Service Worker 腳本 (為了維持單檔案格式)
                const swCode = `
                    const CACHE_NAME = 'planner-cache-v1';
                    self.addEventListener('install', (e) => {
                        e.waitUntil(caches.open(CACHE_NAME).then(cache => cache.addAll(['./'])));
                    });
                    self.addEventListener('fetch', (e) => {
                        e.respondWith(caches.match(e.request).then(res => res || fetch(e.request)));
                    });
                `;
                const blob = new Blob([swCode], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(blob);
                
                navigator.serviceWorker.register(swUrl).then(() => {
                    console.log('PWA Service Worker Registered');
                }).catch(err => console.log('SW Registration Failed', err));
            }

            // 2. 處理安裝按鈕
            let deferredPrompt;
            const installBanner = document.getElementById('install-banner');
            const installBtn = document.getElementById('install-btn');

            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                installBanner.classList.remove('hidden'); // 顯示安裝橫幅
            });

            installBtn.addEventListener('click', async () => {
                if (!deferredPrompt) return;
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    installBanner.classList.add('hidden');
                }
                deferredPrompt = null;
            });
        }

        // 核心功能：新增行程
        function openAddModal() {
            editingId = null;
            document.getElementById('modal-title').innerText = "要去哪裡？";
            document.getElementById('task-input').value = "";
            originalContent = "";
            document.getElementById('editor-modal').classList.remove('hidden');
        }

        // 核心功能：編輯模式
        function openEditModal(id) {
            const task = tasks.find(t => t.id === id);
            editingId = id;
            document.getElementById('modal-title').innerText = "修改行程";
            
            let content = task.content;
            if (content === "未註明事項") content = "";
            
            document.getElementById('task-input').value = content;
            originalContent = content;
            document.getElementById('editor-modal').classList.remove('hidden');
        }

        // 儲存邏輯
        function saveTask() {
            const input = document.getElementById('task-input').value.trim();
            const finalContent = input === "" ? "未註明事項" : input;
            const now = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            if (editingId) {
                const index = tasks.findIndex(t => t.id === editingId);
                tasks[index].content = finalContent;
                tasks[index].time = now;
            } else {
                tasks.push({
                    id: Date.now(),
                    content: finalContent,
                    time: now,
                    completed: false
                });
            }
            
            closeEditorDirectly();
            render();
        }

        // 未儲存警示檢測
        function closeEditorWithCheck() {
            const currentContent = document.getElementById('task-input').value.trim();
            if (currentContent !== originalContent) {
                document.getElementById('alert-modal').classList.remove('hidden');
            } else {
                forceCloseEditor();
            }
        }

        function forceCloseEditor() {
            document.getElementById('alert-modal').classList.add('hidden');
            closeEditorDirectly();
        }

        function closeEditorDirectly() {
            document.getElementById('editor-modal').classList.add('hidden');
            editingId = null;
        }

        // 標記完成
        function toggleComplete(id) {
            const index = tasks.findIndex(t => t.id === id);
            tasks[index].completed = !tasks[index].completed;
            render();
        }

        // 刪除行程
        function moveToTrash(id) {
            const index = tasks.findIndex(t => t.id === id);
            const task = tasks.splice(index, 1)[0];
            trash.push(task);
            render();
            renderTrash();
        }

        // 回收站功能：恢復
        function restoreFromTrash(id) {
            const index = trash.findIndex(t => t.id === id);
            const task = trash.splice(index, 1)[0];
            tasks.push(task);
            render();
            renderTrash();
        }

        // 回收站功能：永久刪除
        function permanentDelete(id) {
            trash = trash.filter(t => t.id !== id);
            renderTrash();
        }

        // 分類過濾切換
        function setFilter(filter) {
            currentFilter = filter;
            
            ['todo', 'all', 'done'].forEach(f => {
                const btn = document.getElementById(`tab-${f}`);
                if (f === filter) {
                    btn.classList.add('border-amber-500', 'text-amber-700');
                    btn.classList.remove('border-transparent', 'text-slate-500');
                } else {
                    btn.classList.remove('border-amber-500', 'text-amber-700');
                    btn.classList.add('border-transparent', 'text-slate-500');
                }
            });

            render();
        }

        function toggleTrash() {
            const panel = document.getElementById('trash-panel');
            panel.classList.toggle('hidden');
            if (!panel.classList.contains('hidden')) {
                renderTrash();
            }
        }

        // 渲染主列表
        function render() {
            const list = document.getElementById('task-list');
            const todoCountEl = document.getElementById('todo-count');
            
            let filteredTasks = tasks;
            if (currentFilter === 'todo') filteredTasks = tasks.filter(t => !t.completed);
            if (currentFilter === 'done') filteredTasks = tasks.filter(t => t.completed);

            const todoCount = tasks.filter(t => !t.completed).length;
            todoCountEl.innerText = todoCount;

            if (filteredTasks.length === 0) {
                list.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-64 text-amber-300">
                        <i class="fas fa-moon text-5xl mb-4"></i>
                        <p class="font-medium">清空所有計畫，休息一下吧</p>
                    </div>
                `;
                return;
            }

            list.innerHTML = filteredTasks.map(task => `
                <div class="task-card bg-white rounded-2xl p-4 shadow-sm border border-amber-50 ${task.completed ? 'completed' : ''}">
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-xs text-amber-800/40 font-medium">
                            ${task.time} 
                            <button onclick="openEditModal(${task.id})" class="ml-2 text-amber-200 hover:text-amber-600">
                                <i class="fas fa-pencil-alt"></i>
                            </button>
                        </span>
                        <button onclick="moveToTrash(${task.id})" class="text-amber-200 hover:text-red-400">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                    <p class="task-text font-bold text-lg mb-4 break-words text-slate-800">${task.content}</p>
                    <button onclick="toggleComplete(${task.id})" 
                            class="w-full py-3 rounded-xl flex items-center justify-center gap-2 font-bold transition-all
                            ${task.completed ? 'bg-white text-amber-700 border border-amber-300' : 'bg-amber-500 text-white shadow-lg shadow-amber-100'}">
                        <i class="fas ${task.completed ? 'fa-undo' : 'fa-check'}"></i>
                        ${task.completed ? '標記為未完成' : '完成後請按這'}
                    </button>
                </div>
            `).join('');
        }

        function renderTrash() {
            const trashList = document.getElementById('trash-list');
            if (trash.length === 0) {
                trashList.innerHTML = `<p class="text-center text-slate-500 py-10">回收站是空的</p>`;
                return;
            }

            trashList.innerHTML = trash.map(item => `
                <div class="bg-slate-800 p-4 rounded-2xl flex items-center justify-between">
                    <div class="flex-1 mr-4">
                        <p class="text-sm font-bold truncate">${item.content}</p>
                        <p class="text-[10px] text-slate-500">刪除於 ${new Date().toLocaleTimeString()}</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="restoreFromTrash(${item.id})" class="w-10 h-10 bg-amber-500/20 text-amber-400 rounded-full flex items-center justify-center">
                            <i class="fas fa-undo-alt"></i>
                        </button>
                        <button onclick="permanentDelete(${item.id})" class="w-10 h-10 bg-red-500/20 text-red-400 rounded-full flex items-center justify-center">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        window.onclick = function(event) {
            const editor = document.getElementById('editor-modal');
            if (event.target === editor) {
                closeEditorWithCheck();
            }
        }

        init();
    </script>
</body>
</html>
